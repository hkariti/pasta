---
- hosts: tv-h
  become: yes
  tasks:
    - name: Install packages
      apt: name={{item}} update_cache=yes state=present
      with_items:
        - python
        - git
        - vim
        - tmux
        - transmission-daemon
        - nginx
        - avahi-daemon

    - name: Create mount point
      file: name=/mnt/downloads state=directory

    - name: Mount downloads dir
      mount: name=/mnt/downloads fstype=ext4 src=LABEL=Downloads state=present

    - name: Create downloads group
      group: name=downloads gid=125 state=present
        
    - name: Put transmission in downloads group
      user: name=debian-transmission groups=downloads append=yes
      notify: restart transmission

    - name: Copy transmission config
      copy: src=config/transmission.settings.json dest=/etc/transmission-daemon/settings.json owner=debian-transmission group=debian-transmission mode=0600
      notify: restart transmission
      tags: transmission
    
    - name: Copy nginx site
      copy: src=config/nginx_route.site dest=/etc/nginx/sites-available/route
      notify: restart nginx
      tags: nginx

    - name: Enable site
      file: src=/etc/nginx/sites-available/route dest=/etc/nginx/sites-enabled/route state=link
      notify: restart nginx
      tags: nginx

    - name: Disable default nginx site
      file: path=/etc/nginx/sites-enabled/default state=absent
      notify: restart nginx
      tags: nginx

    - name: Disable suspend on lid close
      lineinfile: regexp=HandleLidSwitch= line="HandleLidSwitch=ignore" path=/etc/systemd/logind.conf
      notify: restart logind
  roles:
    - role: couchpotato
      group: downloads
    - role: sickrage
      group: downloads
  handlers:
      - name: restart transmission
        service: name=transmission-daemon enabled=yes state=restarted
      - name: restart nginx
        service: name=nginx enabled=yes state=restarted
      - name: restart logind
        service: name=systemd-logind state=restarted
